#include <stdio.h>
#include <math.h> // for sgrt() and trigonometric functions
#include <stdlib.h>
#include <string.h> // for saving calculations in string

const double PI=3.14159265359; // PI for circle calculations

int safeInt() { // input check whether input is int or not
    char buf[200]; // entered input saves here
    int val;
    while (1) {
        if (!fgets(buf, sizeof(buf), stdin)) { // stdin refers to standard input for ex: keyboard
            // if it is successful returns  adress of buf
            // here if it is not successfull it returns NULL and system works
            printf("Invalid input. Enter again: ");
            continue; // requests one more input
        }
        int isValid = 1; // check character
        int i = 0; // index of the entered input
        if (buf[i] == '-') i++; // to take into account negative values
        if (!(buf[i] >= '0' && buf[i] <= '9')) isValid = 0; // it checks the character after -
        for (i++; buf[i] != '\0' && buf[i] != '\n'; i++) { // it checks all characters
            if (!(buf[i] >= '0' && buf[i] <= '9')) {
                isValid = 0;
                break;
            }
        }
        if (isValid && sscanf(buf, "%d", &val) == 1) // sscanf reads value from buf and it saves this in val's adress
            // if sscanf returns a number 1 which means number is read successfully returns the val
            return val;
        printf("Invalid input. Enter again: ");
    }
}

double safeDouble() { // input check whether input is double or not
    char buf[200];
    double val;
    while (1) {
        if (!fgets(buf, sizeof(buf), stdin)) {
            printf("Invalid input. Enter again: ");
            continue;
        }
        int i = 0; // index of the entered input
        int dot = 0;
        int isValid = 1;
        if (buf[i] == '-') i++; // takes into account negative numbers
        if (!(buf[i] >= '0' && buf[i] <= '9')) isValid = 0; // if negative check the 2nd index
        for (i++; buf[i] != '\0' && buf[i] != '\n'; i++) { // checks all indexes
            if (buf[i] == '.') {
                dot++;
                if (dot > 1) { isValid = 0; break; } // if there is more than one dot it is not integer
            } else if (!(buf[i] >= '0' && buf[i] <= '9')) {
                isValid = 0;
                break;
            }
        }
        if (isValid && sscanf(buf, "%lf", &val) == 1)
            return val;
        printf("Invalid input. Enter again: ");
    }
}

// Basic math functions
double summation(double x1, double x2){ return x1+x2; }
double subtraction(double x1, double x2){ return x1-x2; }
double division(double x1, double x2){ return x1/x2; }
double multiplication(double x1, double x2){ return x1*x2; }
double square_root(double x1){ return sqrt(x1); }

// in circle calculations x1 refers to radius
double area_circ(double x1){ return PI*x1*x1; } 
double circumference_circ(double x1){ return 2*PI*x1; }

double deg_to_rad(double x1){ return (x1*PI)/180; }

double exponential_f(double x1, int exponent){
    double mult=1.0; // result of multiplication
    for (int i = 0; i < exponent; i++) mult*=x1;
    return mult;
}

double factorial(int x1){
    int mult=1;
    for(int i=1;i<=x1;i++) mult*=i;
    return mult;
}

double average(int length,int arr[]){
    int tot=0;
    for(int i=0;i<length;i++) tot+=arr[i]; // summation of all numbers in the list
    return (double) tot/length;
}

double std(int length, int arr[]){
    int mean=average(length,arr); // mean of the list
    int tot=0;
    for(int i=0;i<length;i++) tot+=(arr[i]-mean)*(arr[i]-mean);
    return sqrt(tot/length);
}

double sine(double x1){ return sin(x1); }
double cosine(double x1){ return cos(x1); }
double tangent(double x1){ return tan(x1); }

void quadratic_eq(double a, double b, double c){
    double D = b*b - 4*a*c; // discriminant
    if (D > 0){ // if two real roots
        double r1 = (-b + sqrt(D)) / (2*a);
        double r2 = (-b - sqrt(D)) / (2*a);
        printf("Two real roots: x1 = %lf , x2 = %lf\n", r1, r2);
    }
    else if (D == 0){ // if one root
        double r = -b / (2*a);
        printf("One real root: x = %lf\n", r);
    }
    else{ // if imaginal roots
        double real = -b / (2*a);
        double imag = sqrt(-D) / (2*a);
        printf("Complex roots: x1 = %lf + %lfi , x2 = %lf - %lfi\n",
               real, imag, real, imag);
    }
}

void linear_eq(double a, double b){
    if (a == 0){ // when slope is 0, infinite solutions
        printf("Not an equation or infinite solutions.\n");
        return;
    }
    double r = -b / a; // r=root
    printf("Root: x = %lf\n", r);
}

double relative_uncertainty(int length, int arr[]){
    double mean = average(length, arr);
    double sigma = std(length, arr);
    return sigma / mean;
}

double combined_uncertainty(double u1, double u2){
    return sqrt(u1*u1 + u2*u2);
}

int main(){
    int choice; // selected from menu 
    int calc_space; //amount of calculation numbers
    int index=0; // // position of the added calculation
    int angle, exponent, f_number; // angle is for deg_to_rad; exponent is for exp function, f_number is for factorial
    double x1, x2, result; // x1 and x2 are for basic calculations
    int extra_calc_space=0; // it refers to how many more calculations will be added initially it is 0.
    int extra_calc_choice; // it can take only 1(YES) or 0(NO) and 1 means more calculations will be done and 0 means vice versa. 
    char **calc_hist; // it saves string pointer as a pointer
    int arr_length; // length of the array for statistic functions


    printf("How many calculations do you want to make? ");
    calc_space = safeInt(); // checks entered number
    calc_hist = malloc(calc_space * sizeof(char*)); // allocates space for calc_space number of pointers in memory

    do { 
        printf("MENU\n");
        printf("---------------\n");
        printf("1) Summation\n");
        printf("2) Subtraction\n");
        printf("3) Multiplication\n");
        printf("4) Division\n");
        printf("5) Show history\n");
        printf("6) Square root\n");
        printf("7) Area of the circle\n");
        printf("8) Circumference of the circle\n");
        printf("9) Convert degree to rad\n");
        printf("10) Exponential (x^y)\n");
        printf("11) Factorial\n");
        printf("12) Average of the given numbers\n");
        printf("13) Standart deviation\n");
        printf("14) Sin(x)\n");
        printf("15) Cos(x)\n");
        printf("16) Tan(x)\n");
        printf("17) Solve quadratic equation ax^2 + bx + c = 0\n");
        printf("18) Solve linear equation ax + b = 0\n");
        printf("19) Relative uncertainty : \n");
        printf("20) Combined uncertainty : \n");
        printf("21) Exit\n");

        if(index == calc_space + extra_calc_space){ // checks the amount of calculations done
            printf("You achieved maximum limit of calculatons.\n");
            printf("Do you want to calculate more? 1:Yes 0:No ");
            while (1) {
                extra_calc_choice = safeInt();
                if (extra_calc_choice == 0 || extra_calc_choice == 1) break;
                printf("Invalid input. Enter again: ");
            }

            if (extra_calc_choice==1){
                printf("How many more calculations do you want to make? ");
                extra_calc_space += safeInt(); // total calculation space is old calculation space plus new calculation space
                calc_hist = realloc(calc_hist, (calc_space + extra_calc_space) * sizeof(char*)); 
                // reallocates space for calc_space+extra_calc_space number of pointers in memory
            }
            else{
                // before exits the program shows the history
                printf("Calculation history:\n");
                for (int i=0; i<index; i++)
                    printf("%d. %s\n", i+1, calc_hist[i]);

                for (int i=0; i<index; i++) 
                    free(calc_hist[i]); // clears all strings
                free(calc_hist); // clears pointer

                printf("Exit the program.\n");
                return 0;
            }
        }

        printf("Please enter your choice 1-21: ");
        choice = safeInt(); // entered input shoul be integer

        // entered input should be between 1 and 21
        if (choice < 1 || choice > 21) {
            printf("Invalid input. Please input integer between (1 - 21)\n");
            continue;
        }

        char temp[200];

        if (choice == 1){ // summation
            printf("Please enter the first number: ");
            x1 = safeDouble();
            printf("Please enter the second number: ");
            x2 = safeDouble();
            result=summation(x1,x2);
            sprintf(temp, "%lf + %lf = %lf", x1, x2, result); 
            // it formats the calculation in string and saves in temp 
            calc_hist[index] = malloc(strlen(temp)+1); // allocates amount of length of temp 
            strcpy(calc_hist[index], temp); // copy formatted calculation string to history array
            index++; // index is incremented 1 for next calculations
            printf("%s\n", temp);
        }

        if (choice == 2){ // subtraction
            printf("Please enter the first number: ");
            x1 = safeDouble();
            printf("Please enter the second number: ");
            x2 = safeDouble();
            result=subtraction(x1,x2);
            sprintf(temp, "%lf - %lf = %lf", x1, x2, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 3){ // multiplication
            printf("Please enter the first number: ");
            x1 = safeDouble();
            printf("Please enter the second number: ");
            x2 = safeDouble();
            result=multiplication(x1,x2);
            sprintf(temp, "%lf * %lf = %lf", x1, x2, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 4){ // division
            printf("Please enter the first number: ");
            x1 = safeDouble();
            printf("Please enter the second number: ");
            x2 = safeDouble();
            result=division(x1,x2);
            sprintf(temp, "%lf / %lf = %lf", x1, x2, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 5){ // history save
            for (int i=0; i<index; i++)
                printf("%d. %s\n", i+1, calc_hist[i]);
        }
        // prints done calculations so far

        if (choice == 6){ // square root
            printf("Please enter the number: ");
            x1 = safeDouble();
            result=square_root(x1);
            sprintf(temp, "sqrt(%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 7){ // area of the circle
            printf("Enter radius: ");
            x1 = safeDouble();
            result = area_circ(x1);
            sprintf(temp, "Area (%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 8){ // circumference of the circuit
            printf("Enter radius: ");
            x1 = safeDouble();
            result = circumference_circ(x1);
            sprintf(temp, "Circumference (%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 9){ // converting degree to rad
            printf("Enter degrees: ");
            angle = safeInt();
            result = deg_to_rad(angle);
            sprintf(temp, "%d degrees = %lf rad", angle, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 10){ // exponential function
            printf("Enter base: ");
            x1 = safeDouble();
            printf("Enter exponent: ");
            exponent = safeInt();
            result = exponential_f(x1, exponent);
            sprintf(temp, "%lf ^ %d = %lf", x1, exponent, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 11){ // factorial
            printf("Enter number: ");
            f_number = safeInt();
            result = factorial(f_number);
            sprintf(temp, "%d! = %d", f_number, (int)result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 12){ // mean of the given list of the numbers
            printf("Enter list length: ");
            arr_length = safeInt();
            int array[arr_length];
            for(int i=0; i<arr_length; i++){
                printf("Enter number: ");
                array[i] = safeInt(); // checks all entered input
            }
            result = average(arr_length, array);
            sprintf(temp, "Average = %lf", result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 13){ // standard deviation calculation
            printf("Enter list length: ");
            arr_length = safeInt();
            int array[arr_length];
            for(int i=0; i<arr_length; i++){
                printf("Enter number: ");
                array[i] = safeInt();
            }
            result = std(arr_length, array);
            sprintf(temp, "Standard deviation = %lf", result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 14){ // sine calculation
            printf("Enter angle: ");
            x1 = safeDouble();
            double rad = deg_to_rad(x1); // first converts into rad
            result = sine(rad); 
            sprintf(temp, "sin(%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 15){ // cosine calculations
            printf("Enter angle: ");
            x1 = safeDouble();
            double rad = deg_to_rad(x1);
            result = cosine(rad);
            sprintf(temp, "cos(%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 16){ //tangent calculation
            printf("Enter angle: ");
            x1 = safeDouble();
            double rad = deg_to_rad(x1);
            result = tangent(rad);
            sprintf(temp, "tan(%lf) = %lf", x1, result);
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice == 17){ // root of the given second order equation
            double a,b,c;
            printf("Enter a: ");
            a = safeDouble();
            printf("Enter b: ");
            b = safeDouble();
            printf("Enter c: ");
            c = safeDouble();

            quadratic_eq(a,b,c);

            sprintf(temp, "Quadratic D = %lf", b*b - 4*a*c); // why do we save discriminant here
            calc_hist[index] = malloc(strlen(temp)+1);
            strcpy(calc_hist[index], temp);
            index++;
        }

        if (choice == 18){ // root of the linear equation
            double a,b;
            printf("Enter a: ");
            a = safeDouble();
            printf("Enter b: ");
            b = safeDouble();

            linear_eq(a,b);

            if (a != 0){
                result = -b/a;
                sprintf(temp, "Linear root = %lf", result);
                calc_hist[index] = malloc(strlen(temp)+1);
                strcpy(calc_hist[index], temp);
                index++;
            }
        }

        if (choice == 19) { // relative uncertainty calculation
            printf("Please enter the length of the list of numbers: ");
            arr_length = safeInt();
            int array[arr_length];  
            for (int i = 0; i < arr_length; i++) {
                printf("Please enter a number to add to the list: ");
                array[i] = safeInt();  // use safe input
            }
            result = relative_uncertainty(arr_length, array);
            sprintf(temp, "Relative uncertainty = %lf", result);
            calc_hist[index] = malloc(strlen(temp) + 1);
            strcpy(calc_hist[index], temp);
            index++;
            printf("%s\n", temp);
        }

        if (choice==20){ // combined uncertainty
                printf("Enter uncertainty u1: ");
                scanf("%lf",&x1);
                printf("Enter uncertainty u2: ");
                scanf("%lf",&x2);
                result = combined_uncertainty(x1, x2);
                sprintf(temp, "Combined uncertainty = %lf", result);
                calc_hist[index] = malloc(strlen(temp)+1);
                strcpy(calc_hist[index], temp);
                index++;
                printf("%s\n", temp);
        }

        if (choice == 21){ // First shows the calculation history and exit the program
            printf("Calculation history:\n");
            for (int i=0; i<index; i++)
                printf("%d. %s\n", i+1, calc_hist[i]);

            for (int i=0; i<index; i++)
                free(calc_hist[i]); // clears all calculations saved in the memory
            free(calc_hist); // clears the calculation history pointer

            printf("Exit the program.\n");
            return 0;
        }

    } while (1);

    return 0;
}
